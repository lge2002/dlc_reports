<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card-header .spinner-border { width: 1.2rem; height: 1.2rem; vertical-align: text-bottom; }
        pre { font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Automation Process Dashboard</h1>
            <div id="last-updated" class="text-muted small"></div>
        </div>
        
        <div class="row" id="dashboard-grid">
            {% for job in jobs %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card shadow-sm" id="job-{{ job.script_name }}">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span class="text-capitalize">{{ job.script_name }}</span>
                        <span class="badge" data-status-badge>{{ job.get_status_display }}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-2">
                            <strong>Today's Data:</strong>
                            <span data-data-status>
                                {% if job.is_data_available_today %}
                                    <i class="bi bi-check-circle-fill text-success"></i> Available
                                {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i> Missing
                                {% endif %}
                            </span>
                        </p>
                        <p class="card-text small text-muted mb-1">
                            <strong>Last Run:</strong> <span data-last-run>{{ job.last_run_time|date:"M d, Y, P"|default:"Never" }}</span>
                        </p>
                         <p class="card-text small text-muted">
                            <strong>Last Success:</strong> <span data-last-success>{{ job.last_success_time|date:"M d, Y, P"|default:"Never" }}</span>
                        </p>
                        
                        <div class="log-message-container small text-danger bg-light p-2 mt-3 rounded border" style="display: none;" data-log-message-container>
                           <strong class="d-block mb-1">Error Log:</strong>
                           <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;" data-log-message></pre>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <form action="{% url 'run_script' job.script_name %}" method="post" class="d-flex align-items-center">
                            {% csrf_token %}
                            <input type="date" name="run_date" class="form-control form-control-sm me-2" title="Select a date to run for. Leave blank for today.">
                            <button type="submit" class="btn btn-sm btn-primary text-nowrap">
                                <i class="bi bi-play-fill"></i> Run Now
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusEndpoint = "{% url 'dashboard_status_api' %}";

            function getStatusColor(status) {
                switch (status) {
                    case 'SUCCESS': return 'bg-success';
                    case 'FAILED': return 'bg-danger';
                    case 'RUNNING': return 'bg-primary';
                    default: return 'bg-secondary';
                }
            }

            async function updateDashboard() {
                try {
                    const response = await fetch(statusEndpoint);
                    const jobs = await response.json();

                    jobs.forEach(job => {
                        const card = document.getElementById(`job-${job.script_name}`);
                        if (!card) return;

                        // Update Status Badge
                        const statusBadge = card.querySelector('[data-status-badge]');
                        const statusText = job.status.charAt(0).toUpperCase() + job.status.slice(1).toLowerCase();
                        statusBadge.className = `badge ${getStatusColor(job.status)}`;
                        
                        if (job.status === 'RUNNING') {
                            statusBadge.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running`;
                        } else {
                            statusBadge.textContent = statusText;
                        }

                        // Update Data Status Icon
                        const dataStatus = card.querySelector('[data-data-status]');
                        dataStatus.innerHTML = job.is_data_available_today 
                            ? `<i class="bi bi-check-circle-fill text-success"></i> Available`
                            : `<i class="bi bi-x-circle-fill text-danger"></i> Missing`;

                        // Update Timestamps
                        card.querySelector('[data-last-run]').textContent = job.last_run_time || 'Never';
                        card.querySelector('[data-last-success]').textContent = job.last_success_time || 'Never';
                        
                        // Update Log Message
                        const logContainer = card.querySelector('[data-log-message-container]');
                        const logMessage = card.querySelector('[data-log-message]');
                        if (job.status === 'FAILED' && job.log_message) {
                            logMessage.textContent = job.log_message;
                            logContainer.style.display = 'block';
                        } else {
                            logContainer.style.display = 'none';
                        }
                    });

                    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

                } catch (error) {
                    console.error('Failed to fetch dashboard status:', error);
                }
            }

            // Poll every 5 seconds
            setInterval(updateDashboard, 5000);
            updateDashboard(); // Initial call
        });
    </script>
</body>
</html>